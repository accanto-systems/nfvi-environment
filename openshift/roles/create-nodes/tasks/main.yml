- name: check if master nodes are already up
  wait_for:
    port: 22
    host: "{{ hostvars[item]['ansible_host'] }}"
    delay: 5
    timeout: 10
    msg: "Timeout waiting for 22 to respond"
  register: port_check
  ignore_errors: yes
  with_items: "{{ groups['openshift_masters'] }}"
 
- set_fact: 
    ocp_running: "{{ True if port_check.failed == False else False }}"

- name: create ocp masters vagrant dir
  when: ocp_running == false
  file:
    path: /opt/ocpmasters
    state: directory
    mode: '0777'

- name: copy ocp master nodes vagrant file
  when: ocp_running == false
  template: 
    src: ocp-masters.vagrant
    dest: /opt/ocpmasters/Vagrantfile
    mode: 0777

- name: create ocp workers vagrant dir
  when: ocp_running == false
  file:
    path: /opt/ocpworkers
    state: directory
    mode: '0777'

- name: copy ocp worker nodes vagrant file
  when: ocp_running == false
  template: 
    src: ocp-workers.vagrant
    dest: /opt/ocpworkers/Vagrantfile
    mode: 0777

- name: create openshift master node VMs with vagrant - this may take some time
  when: ocp_running == false
  command: vagrant up
  args:
    chdir: /opt/ocpmasters

# - name: create openshift worker node VMs with vagrant - this may take some time
#   when: ocp_running == false
#   command: vagrant up
#   args:
#     chdir: /opt/ocpworkers

- name: Wait for openshift bootstrap to complete
  delegate_to: ocphelper.mytest.accanto.com
  when: ocp_running == false
  shell: /usr/bin/openshift-install --dir=/opt/ocp4 wait-for bootstrap-complete

- name: Wait for openshift bootstrap to complete
  delegate_to: ocphelper.mytest.accanto.com
  when: ocp_running == false
  shell: /usr/bin/openshift-install --dir=/opt/ocp4 wait-for bootstrap-complete

- name: Remove bootstrap node
  when: ocp_running == false
  command: vagrant destroy ocpbootstrap.mytest.accanto.com -f
  args:
    chdir: /opt/ocpmasters

- name: Remove bootstrap from load balancer
  when: ocp_running == false
  delegate_to: ocphelper.mytest.accanto.com
  lineinfile: 
    dest: /etc/haproxy/haproxy.cfg
    state: absent
    regexp: "^   server ocpbootstrap*"

- name: restart load balancer
  delegate_to: ocphelper.mytest.accanto.com
  when: ocp_running == false
  service:
    name: haproxy
    state: restarted

- name: wait for installation to complete
  delegate_to: ocphelper.mytest.accanto.com
  when: ocp_running == false
  shell: /usr/bin/openshift-install --dir=/opt/ocp4 wait-for install-complete
  