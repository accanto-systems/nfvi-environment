- name: install openvpn dependencies
  apt: name={{item}} state=present
  with_items:
     - openvpn
     - bridge-utils
     - easy-rsa

- name: copy openvpn server files
  become: yes
  copy:
    src: ../config/server/
    dest: /etc/openvpn/
    owner: root
    group: root
    mode: 0644

- name: copy openvpn server template
  become: yes
  template:
    src: ../config/server/server.conf
    dest: /etc/openvpn/server.conf
    owner: root
    group: root
    mode: 0644

- name: set ip forwarding
  become: yes
  sysctl:
    name: net.ipv4.ip_forward
    value: 1
    sysctl_set: yes
    state: present
    reload: yes

- name: apply forwarding rules
  become: yes
  script: |
    iptables -I FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
    iptables -I FORWARD -s 10.8.0.0/24 -m conntrack --ctstate NEW -j ACCEPT
    iptables -t nat -I POSTROUTING -s 10.8.0.0/24 -j MASQUERADE
    iptables -I FORWARD -s 10.8.0.0/24 -d 192.168.10.0/24 -m conntrack --ctstate NEW -j ACCEPT
    iptables -I FORWARD -s 10.8.0.0/24 -d {{ openstack_public_cidr.split("/")[0] }}/24 -m conntrack --ctstate NEW -j ACCEPT
    iptables -I FORWARD -s 192.168.10.0/24 -m conntrack --ctstate NEW -j ACCEPT
    iptables -I FORWARD -s {{ openstack_public_cidr.split("/")[0] }}/24 -m conntrack --ctstate NEW -j ACCEPT
    iptables -t nat -I POSTROUTING -s 192.168.10.0.0/24 -j MASQUERADE
    iptables -t nat -I POSTROUTING -s {{ openstack_public_cidr.split("/")[0] }}/24 -j MASQUERADE

- name: start service openvpn
  become: yes
  service:
    name: openvpn@server
    state: started

- name: copy openvpn client 
  become: yes
  template:
    src: ../config/client/client-template.ovpn
    dest: client.ovpn
